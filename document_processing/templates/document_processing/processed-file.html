{% extends 'document_processing/base.html' %}

{% block content %}

<!--<div>-->
<!--    {% if object.processed_text %}-->
<!--        {{ object.processed_text }}-->
<!--    {% else %}-->
<!--        Processing... (Press F5)-->
<!--    {% endif%}-->
<!--</div>-->

<div>
    <h1>KEK</h1>
    {% for file in files %}
    <div class="container mt-3">
        <span class="col-4">{{file.id}} <a href="file.origin_file.url">origin</a></span>
        <progress class="col-4 d-inline progress progress-success file-progress" value="{{file.progress}}" max="100" data-file-id="{{file.id}}"></progress>
    </div>
    {% endfor %}
</div>


{% endblock %}


{% block scripts %}
<script>
  $(document).ready(
      function() {
          $(".file-progress").each(
              function(index){
                  let polling = setInterval(
                      async () => {
                          let current_value = $( this ).attr("value")
                          if (current_value == 100) {
                              clearInterval(polling);
                              return;
                          }
                          console.log($( this ).attr("data-file-id"));
                          let response = await fetch("/progress/" + $( this ).attr("data-file-id"));
                          if (!response.ok){
                              return;
                          }
                          let progress = response.json["progress"]
                          if (current_value < progress){
                              $( this ).attr("value", progress);
                          }
                          console.log( $( this ).attr("data-file-id") + " " + $( this ).attr("value"));


                      }, 2500
                  )
                  // console.log( index + ": " + $( this ).attr('data-file-id') );
              }
          );
      }
  );

</script>
{% endblock scripts %}